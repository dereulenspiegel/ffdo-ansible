local_node: "{{supernodes[0]}}"

supernode_mesh_mac: "{{local_node.mesh_mac}}"
supernode_mesh_ipv4: "{{local_node.mesh_ip_v4}}"
supernode_bat_macaddress: "{{local_node.bat_mac}}"
supernode_mesh_ipv6: "{{local_node.mesh_ip_v6}}"
supernode_local_ip: "{{local_node.public_ip|default(ansible_default_ipv4.address)}}"
supernode_public_interface: "{{local_node.public_interface|default(ansible_default_ipv4.interface)}}"
supernode_dhcp_range_start: "{{local_node.dhcp_range_start}}"
supernode_dhcp_range_end: "{{local_node.dhcp_range_end}}"

supernode_mesh_backbones:
  - name: "{{supernodes[1].name}}"
    remote_ip: "{{supernodes[1].public_ip|ipaddr('address')}}"
    mesh_ip: "{{supernodes[1].mesh_ip_v4|ipaddr('address')}}"
    address_v6: "{{supernodes[1].mesh_ip_v6|ipaddr('address')}}"
    local_ip: "{{supernode_local_ip|ipaddr('address')}}"
    interface: "{{supernode_public_interface}}"
  - name: "{{supernodes[2].name}}"
    remote_ip: "{{supernodes[2].public_ip|ipaddr('address')}}"
    mesh_ip: "{{supernodes[2].mesh_ip_v4|ipaddr('address')}}"
    address_v6: "{{supernodes[2].mesh_ip_v6|ipaddr('address')}}"
    local_ip: "{{supernode_local_ip|ipaddr('address')}}"
    interface: "{{supernode_public_interface}}"

supernode_other_nameserver: "{{supernode_mesh_backbones|map(attribute='mesh_ip')|map('ipaddr','address')|join(' ')}}"
supernode_other_ntp_server: "{{supernode_mesh_backbones|map(attribute='mesh_ip')|map('ipaddr','address')|join(' ')}}"

supernode_uplinks:
  - name: "{{uplinks[0].name}}"
    comment: "{{uplinks[0].tunnel[0].comment|default('No comment')}}"
    address: "{{local_node.uplink_tunnel_ip|ipaddr('address')}}"
    dstaddr: "{{uplinks[0].tunnel[0].tunnel_ip|ipaddr('address')}}"
    netmask: "{{uplinks[0].tunnel[0].tunnel_ip|ipaddr('netmask')}}"
    endpoint: "{{uplinks[0].public_ip|ipaddr('address')}}"
    address_v6: "{{local_node.uplink_tunnel_ip_v6}}"
    as: "{{uplinks[0].as}}"

supernode_interfaces:
  - name: eth0
    auto: true
    proto: inet
    type: dhcp
  - name: eth1
    auto: true
    proto: inet
    type: static
    config:
    - key: address
      value: "{{supernode_local_ip|ipaddr('address')}}"
    - key: netmask
      value: "{{supernode_local_ip|ipaddr('netmask')}}"
    - key: broadcast
      value: "{{supernode_local_ip|ipaddr('broadcast')}}"