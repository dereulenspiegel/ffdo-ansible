---
# tasks file for ff-supernode

- include_vars: "{{ ansible_distribution }}-{{ansible_distribution_release }}.yml"
  when: ansible_distribution_release == 'wheezy' and ansible_distribution == 'Debian'

- name: Install custom resolv.conf
  template: src=resolv.conf.j2 dest=/etc/resolv.conf

- name: Make sure necessary tools are installed
  apt: name={{item}} state=present
  with_items:
  - wget
  - ntp
  - git

- name: Install dependencies for ffrl tools
  apt: name={{item}}
  with_items:
  - python3
  - python3-pip

- name: Install crontab to update the blacklist
  cron:
    name: Update blacklist
    minute: '*/5'
    job: wget -q -O /etc/fastd/fastd-blacklist.json https://raw.githubusercontent.com/ffruhr/fastdbl/master/fastd-blacklist.json

- name: Install verify shell script
  template: src=fastd-blacklist.sh.j2 dest=/etc/fastd/fastd-blacklist.sh mode="u=rwx,g=rx,o=r"

- name: Install systemd services
  template: src={{item}}.service.j2 dest=/etc/systemd/system/{{item}}.service
  with_items:
  - alfred
  - batadv-vis

- name: Enable and start systemd services
  service: name={{item}} enabled=yes state=started
  with_items:
  - alfred
  - batadv-vis

- name: Install ntp.conf
  template: src=ntp.conf.j2 dest=/etc/ntp.conf

- name: Install python dependencies for ffrl tools
  pip: name={{item}} executable={{supernode_pip_executable}}
  with_items:
  - pyroute2

- name: Create install dir for ffrl tools
  file: dest={{supernode_freifunk_tools_dir}} state=directory

- name: Clone ffrl tools
  git: repo={{supernode_freifunk_tools_repo}} dest={{supernode_freifunk_tools_dir}}

- name: Install nodeinfo cron job
  template: src=nodeinfo.cron.j2 dest=/etc/cron.d/nodeinfo
